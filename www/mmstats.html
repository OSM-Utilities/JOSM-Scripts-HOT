
<html>
  <head>
<title>mmstats</title>

  </head>
<body>
  <h1>mmstats</h1>
  <script src="../lib/jquery.js"></script>
  <script src="../lib/mmstats.js"></script>
<h2>Your query</h2>
<div id="getInput">
<p><b>Hastags and users.</b> Provide hashtags (omit #, comma-separated). This will be used to obtain the user names that have contributed under these hashtags.</p>
<input type="text" id ="hashtag" style="width:50%"> <br/>
<p>If you wish, you can provide a list of of user IDs (which will be added to the list derived from the hashtags).:</p>
<input type="text" id="user" value=""> <br/>
<p><b>Narrow it down to your mapathon.</b> Now that that you have the full user list, you need to narrow down the list of edits, either to the duration of your mapathon, or to a geographical areas. If you do not do that, this tool will retrieve all edits (anywhere, anytime) for the above user list.</p>
<p>Provide a start time (format yyyy-mm-dd_hh:mm:ss).</p>
<input type="text" id ="from"  value=""> <input type="button" value="Now" id="now" ><br/>
<p>Provide an end time (format yyyy-mm-dd_hh:mm:ss):</p>
<input type="text" id="to" value=""> <br/>
<p>Provide an area (bounding box; left,bottom,right,top; bbox = min Longitude , min Latitude , max Longitude , max Latitude; use a map / JOSM to copy/paste coords of SW and NE point of bounding box; in JOSM, Download->Areas around places, select area, then switch to bookmarks or bounding box tab, and copy values):</p>
<input type="text" id="bbox" value="">,
Tanzania: <input type="button" value="29.3269773,-11.761254,40.6584071,-0.9854812" id="Tanzania" >
Zambia: <input type="button" value="21.9993509,-18.0766965,33.7025,-8.2712822" id="Zambia" >
<br/> 
<p><b>Provide the tags the mappers are supposed to use.</b> Tags used in project: (cannot be changed yet)</p>
<i>building,highway,landuse,natural,waterway,railway,barrier,historic,amenity</i><br/>
<!-- <input type="text" id="acceptedTags" value="building,highway,landuse,natural,waterway,railway,barrier,historic,amenity"> <br/> -->
<br/>
<b>Configure</b><br/>
<input type="checkbox" id="RedCrossStats" checked>Show user stats from Red Cross API.<br/>
<input type="checkbox" id="queryResults" checked>Run and show results of overpass query <br/>
<input type="checkbox" id="alwaysShowOPdetails" >Always show details from overpass query, even if there are no errors for a particular user.<br/>
<input type="checkbox" id="showAPIqueries">Show the API queries<br/>
<br/>
<input type="button" value="Submit" id="submit" >
<input type="button" value="Bookmark this query" id="query" >
<input type="button" value="Bookmark this query (autorun)" id="queryRun" >
<br/>
</div>

<div><a id="link" style="display: none;" target="_blank"> Bookmark this link </a></div>

<div id="backInput">
<input type="button" value="Show query" id="back" style="display: none;">
</div>

<h2>Output</h2>

<table id="myTable">
</table>

<div id="output">
</div>

<script>
    var parsed = getUrlVars();
	var parameters = ["hashtag","from","to","user"]; 
	for (var i = 0; i < parameters.length; i++) {
	        if (parsed[parameters[i]] != undefined){
		    document.getElementById(parameters[i]).value = parsed[parameters[i]];
		}
	}
		
       var boxes = ["RedCrossStats","queryResults","alwaysShowOPdetails","showAPIqueries"]; 
        for (var i = 0; i < boxes.length; i++) {
        	if (parsed[boxes[i]] != undefined){
                	document.getElementById(boxes[i]).checked = (parsed[boxes[i]] > 0 || parsed[boxes[i]] == 'true');
            	}
	}

        if (parsed["autorun"] != undefined){
		runmmstats();
	}

  $(document).ready(function(){
    $('#submit').click(function(){
	var url = generateURL(false);
	window.history.pushState('', "mmstats",url);
        $("#back").show();
	$("#link").hide();
	runmmstats();
    });
  });

  $(document).ready(function()
      {  
        $("#query").click(function() {
		url = generateURL(false);
		document.getElementById("link").setAttribute("href",url);
	         $("#link").show()
         });  
       });   
	   
  $(document).ready(function()
      {  
        $("#queryRun").click(function() {
		var url = generateURL(true);
                document.getElementById("link").setAttribute("href",url);
	         $("#link").show()
         });  
       });  

  $(document).ready(function()
      {  
        $("#now").click(function() {
		var currentdate = new Date();
		currentdate.toISOString().substring(0, 10);
		var datetime = setCorrectTime(currentdate);
		document.getElementById("from").value = datetime;
		
		var currentdate = new Date();
		currentdate.setHours(currentdate.getHours() + 3);
		currentdate.toISOString().substring(0, 10);
		var datetime = setCorrectTime(currentdate);
		document.getElementById("to").value = datetime;
         });  
       });      

  $(document).ready(function()
      {  
        $("#back").click(function() {
		window.location.reload();  //BH: Would be better to just show the div that has the query details. Then the query can keep running.
         });  
       });   

 function generateURL(autorun){
                var hashtag = document.getElementById("hashtag").value;
                var from = document.getElementById("from").value;
                var to = document.getElementById("to").value;
                var user = document.getElementById("user").value;
                var url = "mmstats.html?hashtag="+hashtag+"&from="+from+"&to="+to+"&user="+user;

	        var RedCrossStats = document.getElementById("RedCrossStats").checked;
	        var queryResults = document.getElementById("queryResults").checked;
        	var alwaysShowOPdetails = document.getElementById("alwaysShowOPdetails").checked;
	        var showAPIqueries = document.getElementById("showAPIqueries").checked;
		url += "&RedCrossStats="+RedCrossStats+"&queryResults="+queryResults+"&alwaysShowOPdetails="+alwaysShowOPdetails+"&showAPIqueries="+showAPIqueries;
		if (autorun == true)
			url += "&autorun=1";
		return url;
 };

 function runmmstats(){
        $("#getInput").hide();
        var user = document.getElementById("user").value;
        var hashtag = document.getElementById("hashtag").value;
        var array = hashtag.split(',');
        var from = document.getElementById("from").value;
        var to = document.getElementById("to").value;
        from = from.split("_");
        to = to.split("_");
        from = from[0] + "T" + from[1] + "Z";
        to = to[0] + "T" + to[1] + "Z";
        var userarr = []; 
        if (user !== "") {
                userarr = user.split(",");
        };
        var RedCrossStats = document.getElementById("RedCrossStats").checked;
        var queryResults = document.getElementById("queryResults").checked;
        var alwaysShowOPdetails = document.getElementById("alwaysShowOPdetails").checked;
        var showAPIqueries = document.getElementById("showAPIqueries").checked;
        consolelog("");
        analyse(userarr,array,from,to,RedCrossStats,queryResults,alwaysShowOPdetails,showAPIqueries);
  };

  function consolelog(string) {
    var e = document.getElementById("output");
    var regex = /\[((user|node|way|relation)\/[^\]]+)\]/gi;
    var regex2 = /\[(http[^\] ]+) ([^\]]+)\]/gi;
    if ( regex.test(string) || regex2.test(string) ){
       //var a = string.split(":");
       var span = document.createElement('span');
       string = string.replace(regex,"<a href=\"http://www.openstreetmap.org/$1\" target=\"_blank\">$1</a>");
       string = string.replace(regex2,"<a href=\"$1\" target=\"_blank\">$2</a>");
       span.innerHTML = string;
       e.append(span);
    } else {
       e.append(document.createTextNode(string) );
    };
    e.append(document.createElement('br'));
    };
  
  function createTable(tableData,tableInfo) {
    var table = document.createElement('table');;
    var tableBody = document.createElement('tbody');

    var row = document.createElement('tr');
    tableData[0].forEach(function(cellData) {
        var cell = document.createElement('th');
        cell.appendChild(document.createTextNode(cellData));
        row.appendChild(cell);
      });
    tableBody.appendChild(row);
    tableData.shift();      

    tableData.forEach(function(rowData) {
      var row = document.createElement('tr');

      rowData.forEach(function(cellData) {
        var cell = document.createElement('td');
        cell.appendChild(document.createTextNode(cellData));
        row.appendChild(cell);
      });
  
      tableBody.appendChild(row);
    });
  
    table.appendChild(tableBody);
    t = document.getElementById("myTable");
    t.append(document.createTextNode(tableInfo) );
    t.appendChild(table);
  }
</script>

<style>
table {
    border-spacing: 5px;
    text-align: center;
}
tr:nth-child(2) {
    background-color:yellow;
}

td {
  padding: 0 15px;
}
</style>



<address>
</address>
</body>
</html>
