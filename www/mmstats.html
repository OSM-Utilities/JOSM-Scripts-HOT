
<html>
  <head>
<title>mmstats</title>

  </head>
<body>
  <h1>mmstats</h1>
  <script src="../lib/jquery.js"></script>
  <script src="../lib/mmstats.js"></script>

<div id="getInput"
<p>Type in hashtags (omit #, comma-separated):</p>
<input type="text" id ="hashtag" style="width:50%"> </br>
<p>Type in a start time (format yyyy-mm-dd_hh:mm:ss):</p>
<input type="text" id ="from"  value=""> </br>
<input type="button" value="Now" id="now" >
<p>Type in an end time (format yyyy-mm-dd_hh:mm:ss):</p>
<input type="text" id="to" value=""> </br>
<p>Type in a user ID:</p>
<input type="text" id="user" value=""> </br>
</br>
<input type="checkbox" id="rc" checked>Show user stats from Red Cross API.</br>
<input type="checkbox" id="overpass" checked>Run and show results of overpass query </br>
<input type="checkbox" id="alwaysShowOPdetails">Always show details from overpass query, even if here are no errors.</br>
<input type="checkbox" id="showAPIqueries">Show details of API queries.</br>
</br>
<input type="button" value="Submit" id="submit" >
<input type="button" value="Bookmark this query" id="query" >
<input type="button" value="Bookmark this query (autorun)" id="queryRun" >
</br>
</div>

<a id="link" style="display: none;" target="_blank"> Link </a>

<table id="myTable">
</table>

<div id="output">
</div>

<script>
    var parsed = getUrlVars();
	var parameters = ["hashtag","from","to","user"]; 
	for (var i = 0; i < parameters.length; i++) {
        if (parsed[parameters[i]] != undefined){
		    document.getElementById(parameters[i]).value = parsed[parameters[i]];
		}
    }

  $(document).ready(function(){
    $('#submit').click(function(){
	   var user = document.getElementById("user").value;
	   var hashtag = document.getElementById("hashtag").value;
	   var array = hashtag.split(',');
	   var from = document.getElementById("from").value;
	   var to = document.getElementById("to").value;
	   from = from.split("_");
	   to = to.split("_");
	   from = from[0] + "T" + from[1] + "Z";
	   to = to[0] + "T" + to[1] + "Z";
	   var userarr = []; 
	   if (user !== "") {
		userarr = user.split(",");
	   };
           var response = document.getElementById("rc").checked;
           var query = document.getElementById("overpass").checked;
	   consolelog("");
	   analyse(userarr,array,from,to,response,query);
    });
  });
  
  $(document).ready(function()
      {  
        $("#query").click(function() {
		var hashtag = document.getElementById("hashtag").value;
		var from = document.getElementById("from").value;
		var to = document.getElementById("to").value;
		var user = document.getElementById("user").value;
		var url = "mmstats.html?hashtag="+hashtag+"&from="+from+"&to="+to+"&user="+user;
		document.getElementById("link").setAttribute("href",url);
         $("#link").toggle()
         });  
       });   
	   
  $(document).ready(function()
      {  
        $("#now").click(function() {
		var currentdate = new Date();
		currentdate.toISOString().substring(0, 10);
		var datetime = setCorrectTime(currentdate);
		document.getElementById("from").value = datetime;
		
		var currentdate = new Date();
		currentdate.setHours(currentdate.getHours() + 3);
		currentdate.toISOString().substring(0, 10);
		var datetime = setCorrectTime(currentdate);
		document.getElementById("to").value = datetime;
         });  
       });      

  function consolelog(string) {
    var e = document.getElementById("output");
    var regex = /\[((user|node|way|relation)\/[^\]]+)\]/gi;
    if ( regex.test(string) ){
       var a = string.split(":");
       var span = document.createElement('span');
       string = string.replace(regex,"<a href=\"http://www.openstreetmap.org/$1\" target=\"_blank\">$1</a>");
       span.innerHTML = string;
       e.append(span);
    } else{
       e.append(document.createTextNode(string) );
    };
    e.append(document.createElement('br'));
    };
  
  function createTable(tableData,tableInfo) {
    var table = document.createElement('table');;
    var tableBody = document.createElement('tbody');

    var row = document.createElement('tr');
    tableData[0].forEach(function(cellData) {
        var cell = document.createElement('th');
        cell.appendChild(document.createTextNode(cellData));
        row.appendChild(cell);
      });
    tableBody.appendChild(row);
    tableData.shift();      

    tableData.forEach(function(rowData) {
      var row = document.createElement('tr');

      rowData.forEach(function(cellData) {
        var cell = document.createElement('td');
        cell.appendChild(document.createTextNode(cellData));
        row.appendChild(cell);
      });
  
      tableBody.appendChild(row);
    });
  
    table.appendChild(tableBody);
    t = document.getElementById("myTable");
    t.append(document.createTextNode(tableInfo) );
    t.appendChild(table);
  }
</script>

<style>
table {
    border-spacing: 5px;
    text-align: center;
}

</style>



<address>
</address>
</body>
</html>
